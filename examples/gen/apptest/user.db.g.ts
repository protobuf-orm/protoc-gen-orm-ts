// Code generated by protoc-gen-orm-ts. DO NOT EDIT.

import { create, type MessageInitShape } from "@bufbuild/protobuf";
import { Code } from "@connectrpc/connect";
import { DbBase, type DbOf, type EntityOf, type Key, uuid } from "@protobuf-orm/runtime";

import type { UserServiceClient } from "./client.g"
import { type User, UserSchema } from "./user_pb.ts"
import type { UserGetRequestSchema } from "./user_svc.g_pb.ts"

type Desc = typeof UserSchema
export type Db = DbOf<Desc>

export const TableName = "apptest.User";
export const Schema = ",[alias+tenant.id]" as const;

export class UserServiceDb extends DbBase<Desc> implements Partial<UserServiceClient> {
	constructor(db: Db) {
		super(db, UserSchema);
	}

	_dehydrate(v: User): [Key, any] {
		const w = v as unknown as any
		const k = uuid.u8_str(v.id)
		if(k === undefined) throw this._err("invalid key", Code.InvalidArgument)
		w.id = k
		w.tenant.id = uuid.u8_str(v.tenant?.id)
		return [k, v]
	}

	_hydrate(v: any): User {
		v.id = uuid.str_u8(v.id)
		v.tenant.id = uuid.str_u8(v.tenant?.id)
		return create(this._schema, v)
	}

	_versioned(): boolean {
		return true
	}

	_compare(a: EntityOf<Desc>, b: EntityOf<Desc>): number {
		if(a.dateUpdated === undefined) return 1
		if(b.dateUpdated === undefined) return -1
		const d = a.dateUpdated.seconds - b.dateUpdated.seconds
		if(d > 0) return 1
		if(d < 0) return -1
		return a.dateUpdated.nanos - b.dateUpdated.nanos
	}

	get(req: MessageInitShape<typeof UserGetRequestSchema>): Promise<User> {
		if(req.ref?.key === undefined) return Promise.reject(this._err("key undefined", Code.InvalidArgument));
		const { key } = req.ref;
		switch(key.case) {
			case "id": {
				const k = uuid.u8_str(key.value);
				if(k === undefined) return Promise.reject(this._err("invalid key", Code.InvalidArgument));
				return this._query(t => t.get(k));
			}

			case "alias": {
				const v = key.value;
				const q = {
					'alias': v.alias,
					'tenant.id': uuid.u8_str(v.tenant?.key?.value),
				}
				return this._query(t => t.where(q).first());
			}

			default:
				return Promise.reject(this._err(`unknown key: ${key.case}`, Code.InvalidArgument));
		}
	}
}
